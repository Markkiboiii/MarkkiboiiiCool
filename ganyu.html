<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Number Randomizer</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { background: radial-gradient(circle at bottom, #2e026d, #1e1b4b); }
    .number-display { text-shadow: 0 0 10px #a855f7, 0 0 20px #9333ea; }
    input[type=number]::-webkit-inner-spin-button,
    input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
    input[type=number] { -moz-appearance: textfield; }
  </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-4">

  <!-- Top controls -->
  <div class="fixed top-4 left-4 flex space-x-2 z-50">
    <a href="index.html" class="bg-gray-600 hover:bg-gray-700 text-white px-3 py-2 rounded-lg text-sm flex items-center">
      <i data-feather="arrow-left" class="mr-1"></i> Back
    </a>
    <button id="logoutBtn" class="bg-red-600 hover:bg-red-700 text-white px-3 py-2 rounded-lg text-sm flex items-center">
      <i data-feather="log-out" class="mr-1"></i> Logout
    </button>
  </div>

  <!-- Welcome -->
  <div id="welcomeUser" class="fixed top-4 right-4 text-white text-sm font-medium z-50"></div>

  <div class="max-w-md w-full bg-white/10 backdrop-blur-md rounded-xl shadow-2xl overflow-hidden p-8">
    <h1 class="text-3xl font-bold text-white mb-2 text-center">Number Randomizer</h1>
    <p id="bonusInfo" class="text-green-400 text-center mb-4"></p>

    <!-- Graph -->
    <div class="bg-white/10 rounded-lg p-6 mb-6">
      <canvas id="numberChart"></canvas>
    </div>

    <!-- Input -->
    <div class="mb-6">
      <label for="numberInput" class="block text-sm font-medium text-white mb-2">Add to number:</label>
      <div class="flex">
        <input type="number" id="numberInput" class="flex-1 rounded-l-lg px-4 py-3 bg-white/90 text-gray-800" placeholder="Enter a number to add">
        <button id="submitBtn" class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-3 rounded-r-lg flex items-center">
          <i data-feather="plus" class="mr-2"></i> Add
        </button>
      </div>
    </div>

    <!-- Current number -->
    <div class="bg-white/10 rounded-lg p-6 mb-6">
      <p class="text-white/80 mb-2">Current number:</p>
      <div id="numberDisplay" class="text-5xl font-bold text-white text-center number-display">10</div>
    </div>

    <!-- Mascot -->
    <div class="bg-white/10 rounded-lg p-6 mb-6 text-center">
      <p class="text-white/80 mb-2">Our Mascot</p>
      <img src="mascot.png" alt="Mascot" class="mx-auto w-40 h-40 object-cover rounded-full shadow-lg">
    </div>

    <!-- Stars -->
    <div class="bg-white/10 rounded-lg p-6 mb-6">
      <p class="text-white/80 mb-2">Your stars:</p>
      <ul id="starsList" class="text-white text-center space-y-1"></ul>
    </div>

    <!-- Referral Code -->
    <div class="bg-white/10 rounded-lg p-6 mb-6 text-center">
      <p class="text-white/80 mb-2">Share your referral code:</p>
      <p id="referralCode" class="text-yellow-300 font-bold text-lg"></p>
    </div>

    <!-- Referral History -->
    <div class="bg-white/10 rounded-lg p-6 mb-6">
      <p class="text-white/80 mb-2">Referral History:</p>
      <ul id="referralHistory" class="text-white text-center space-y-1"></ul>
    </div>
  </div>

  <script>
    feather.replace();

    const loggedInUser = localStorage.getItem('loggedInUser');
    if (!loggedInUser) window.location.href = "index.html";

    document.getElementById('welcomeUser').textContent = `Welcome, ${loggedInUser}`;
    document.getElementById('referralCode').textContent = loggedInUser;

    const numberDisplay = document.getElementById('numberDisplay');
    const bonusInfo = document.getElementById('bonusInfo');
    const referralHistoryEl = document.getElementById('referralHistory');
    const ctx = document.getElementById('numberChart').getContext('2d');

    let currentNumber = 10;
    let step = 0;

    // Chart setup
    const numberChart = new Chart(ctx, {
      type: 'line',
      data: { labels: [], datasets: [
        { label: "Live", data: [], borderColor: 'rgba(255,255,255,0.9)', backgroundColor: 'rgba(168,85,247,0.3)', borderWidth: 2, tension: 0.3, fill: true },
        { label: "Offline", data: [], borderColor: 'rgba(255,255,255,0.3)', borderWidth: 1, borderDash: [5,5], tension: 0.3, fill: false }
      ]},
      options: { responsive:true, plugins:{legend:{labels:{color:'white'}}}, scales:{
        x:{ticks:{display:false},grid:{color:'rgba(255,255,255,0.1)'}},
        y:{ticks:{color:'white'},grid:{color:'rgba(255,255,255,0.1)'}}
      }}
    });

    const users = JSON.parse(localStorage.getItem('users') || '{}');

    // --- Referral bonus + history starts here ---
    if (users[loggedInUser]) {
      if (users[loggedInUser].referralBonus) {
        currentNumber = 20;
        bonusInfo.textContent = "🎁 You joined with a referral code! Starting bonus: +10";
        users[loggedInUser].referralBonus = false;
      } else {
        currentNumber = parseInt(localStorage.getItem(loggedInUser + "_number") || "10");
        if (users[loggedInUser].gotReferralBonus) {
          bonusInfo.textContent = "🎁 You earned a referral reward! Permanent +10 applied.";
        }
      }
      localStorage.setItem('users', JSON.stringify(users));
    }

    // Show referral history
    const history = JSON.parse(localStorage.getItem(loggedInUser + "_referrals") || "[]");
    referralHistoryEl.innerHTML = "";
    history.forEach(name => {
      const li = document.createElement("li");
      li.textContent = `⭐ You referred ${name} (+10 bonus)`;
      referralHistoryEl.appendChild(li);
    });
    // --- Referral bonus + history ends here ---

    // --- Load saved state and simulate offline updates ---
    let savedLabels = JSON.parse(localStorage.getItem(loggedInUser + "_labels") || "[]");
    let savedLiveData = JSON.parse(localStorage.getItem(loggedInUser + "_liveData") || "[]");
    let savedOfflineData = JSON.parse(localStorage.getItem(loggedInUser + "_offlineData") || "[]");
    let lastUpdate = parseInt(localStorage.getItem(loggedInUser + "_lastUpdate") || "0");

    if (savedLabels.length > 0) {
      currentNumber = parseInt(localStorage.getItem(loggedInUser + "_number") || "10");
      step = savedLabels[savedLabels.length - 1];
      numberChart.data.labels = savedLabels;
      numberChart.data.datasets[0].data = savedLiveData;
      numberChart.data.datasets[1].data = savedOfflineData;
      numberChart.update();

      if (lastUpdate > 0) {
        const now = Date.now();
        const elapsed = Math.floor((now - lastUpdate) / 30000); // every 30s
        for (let i = 0; i < elapsed; i++) {
          randomStep();
          step++;
          numberChart.data.labels.push(step);
          numberChart.data.datasets[1].data.push(currentNumber);
        }
        numberDisplay.textContent = currentNumber;
        numberChart.update();
      }
    } else {
      localStorage.setItem(loggedInUser + "_number", currentNumber);
    }
    // --- End offline simulation ---

    numberDisplay.textContent = currentNumber;

    // Update number every 3s
    function randomStep() {
      const r = Math.random();
      if (r < 0.5) currentNumber++;
      else if (r < 0.75) currentNumber--;
    }
    function updateNumber() {
      randomStep();
      numberDisplay.textContent = currentNumber;
      step++;
      numberChart.data.labels.push(step);
      numberChart.data.datasets[0].data.push(currentNumber);
      numberChart.update();
      saveState();
    }
    setInterval(updateNumber, 3000);

    function saveState() {
      localStorage.setItem(loggedInUser + "_number", currentNumber);
      localStorage.setItem(loggedInUser + "_labels", JSON.stringify(numberChart.data.labels));
      localStorage.setItem(loggedInUser + "_liveData", JSON.stringify(numberChart.data.datasets[0].data));
      localStorage.setItem(loggedInUser + "_offlineData", JSON.stringify(numberChart.data.datasets[1].data));
      localStorage.setItem(loggedInUser + "_lastUpdate", Date.now());
    }

    // Stars system
    const starsList = document.getElementById('starsList');
    const starTypes = [
      "Star of Happy","Star of Shiny","Star of Luck","Star of Peace","Star of Joy",
      "Star of Dreams","Star of Magic","Star of Wonder","Star of Hope","Star of Light",
      "Star of Night","Star of Dawn","Star of Energy","Star of Love","Star of Mystery"
    ];
    let availableStars = [...starTypes];
    function addStar() {
      const chanceDisappear = Math.random();
      if (starsList.children.length > 0 && chanceDisappear < 0.2) {
        const index = Math.floor(Math.random() * starsList.children.length);
        const starText = starsList.children[index].textContent.replace("⭐ ", "");
        availableStars.push(starText);
        starsList.removeChild(starsList.children[index]);
      } else if (availableStars.length > 0) {
        const starIndex = Math.floor(Math.random() * availableStars.length);
        const star = availableStars.splice(starIndex, 1)[0];
        const li = document.createElement("li");
        li.textContent = `⭐ ${star}`;
        starsList.appendChild(li);
      }
    }
    setInterval(addStar, 15000);

    // Logout
    document.getElementById('logoutBtn').addEventListener('click', () => {
      localStorage.removeItem('loggedInUser');
      window.location.href = "index.html";
    });

    // Add custom number
    document.getElementById('submitBtn').addEventListener('click', () => {
      const inputValue = parseInt(document.getElementById('numberInput').value);
      if (!isNaN(inputValue)) {
        currentNumber += inputValue;
        numberDisplay.textContent = currentNumber;
        step++;
        numberChart.data.labels.push(step);
        numberChart.data.datasets[0].data.push(currentNumber);
        numberChart.update();
        saveState();
      }
    });
  </script>
</body>
</html>
