<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Number Randomizer</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
  <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    .number-display { transition: all 0.3s ease; }
    .number-change { animation: pulse 0.5s; }
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.2); }
      100% { transform: scale(1); }
    }

    /* 🔹 Remove up/down arrows from number input */
    input[type=number]::-webkit-inner-spin-button, 
    input[type=number]::-webkit-outer-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    input[type=number] {
      -moz-appearance: textfield; /* Firefox */
    }
  </style>
</head>
<body class="bg-gradient-to-br from-indigo-900 to-purple-800 min-h-screen flex flex-col items-center justify-center p-4">
  <!-- Top-left controls -->
  <div class="fixed top-4 left-4 flex space-x-2 z-50">
    <a href="index.html" class="bg-gray-600 hover:bg-gray-700 text-white px-3 py-2 rounded-lg text-sm transition-colors duration-200 flex items-center">
      <i data-feather="arrow-left" class="mr-1"></i> Back
    </a>
    <button id="logoutBtn" class="bg-red-600 hover:bg-red-700 text-white px-3 py-2 rounded-lg text-sm transition-colors duration-200 flex items-center">
      <i data-feather="log-out" class="mr-1"></i> Logout
    </button>
  </div>

  <!-- Welcome user -->
  <div id="welcomeUser" class="fixed top-4 right-4 text-white text-sm font-medium z-50"></div>

  <div class="max-w-md w-full bg-white/10 backdrop-blur-md rounded-xl shadow-2xl overflow-hidden p-8" data-aos="fade-up">
    <div class="text-center mb-8">
      <h1 class="text-3xl font-bold text-white mb-2">Number Randomizer</h1>
      <p class="text-white/80">Watch your number evolve with random changes!</p>
    </div>

    <!-- Graph -->
    <div class="bg-white/10 rounded-lg p-6 mb-6">
      <canvas id="numberChart"></canvas>
    </div>

    <!-- Input -->
    <div class="mb-6">
      <label for="numberInput" class="block text-sm font-medium text-white mb-2">Add to number:</label>
      <div class="flex">
        <input type="number" id="numberInput" class="flex-1 rounded-l-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-purple-400 bg-white/90 text-gray-800" placeholder="Enter a number to add">
        <button id="submitBtn" class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-3 rounded-r-lg transition-colors duration-200 flex items-center animate-pulse">
          <i data-feather="plus" class="mr-2"></i> Add
        </button>
      </div>
    </div>

    <!-- Current number -->
    <div class="bg-white/10 rounded-lg p-6 mb-6 transition-all duration-300 hover:bg-white/20">
      <p class="text-white/80 mb-2">Current number:</p>
      <div id="numberDisplay" class="text-5xl font-bold text-white text-center number-display">10</div>
    </div>

    <!-- Mascot -->
    <div class="bg-white/10 rounded-lg p-6 mb-6 transition-all duration-300 hover:bg-white/20 text-center">
      <p class="text-white/80 mb-2">Our Mascot</p>
      <img src="mascot.png" alt="Mascot" class="mx-auto rounded-lg shadow-lg w-40 h-40 object-cover">
    </div>

    <!-- Stars -->
    <div class="bg-white/10 rounded-lg p-6 mb-6 transition-all duration-300 hover:bg-white/20">
      <p class="text-white/80 mb-2">Your stars:</p>
      <ul id="starsList" class="text-white text-center space-y-1"></ul>
    </div>

    <!-- Clear button -->
    <div class="flex justify-center">
      <button id="clearBtn" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg text-sm transition-colors duration-200 flex items-center">
        <i data-feather="trash-2" class="mr-2"></i> Clear Saved Data
      </button>
    </div>
  </div>

  <script>
    AOS.init();
    feather.replace();

    // Redirect if not logged in
    const loggedInUser = localStorage.getItem('loggedInUser');
    if (!loggedInUser) {
      window.location.href = "index.html";
    } else {
      document.getElementById('welcomeUser').textContent = `Welcome, ${loggedInUser}`;
    }

    function getKey(key) {
      return `${loggedInUser}_${key}`;
    }

    // Logout
    document.getElementById('logoutBtn').addEventListener('click', () => {
      localStorage.removeItem('loggedInUser');
      window.location.href = "index.html";
    });

    const numberInput = document.getElementById('numberInput');
    const submitBtn = document.getElementById('submitBtn');
    const clearBtn = document.getElementById('clearBtn');
    const numberDisplay = document.getElementById('numberDisplay');
    const starsList = document.getElementById('starsList');
    const ctx = document.getElementById('numberChart').getContext('2d');

    let intervalId = null;
    let starIntervalId = null;
    let currentNumber = 10; // default starting point
    let step = 0;

    const numberChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: [],
        datasets: [
          { label: "Live", data: [], borderColor: 'rgba(255, 255, 255, 0.9)', backgroundColor: 'rgba(168, 85, 247, 0.3)', borderWidth: 2, tension: 0.3, fill: true },
          { label: "Offline", data: [], borderColor: 'rgba(255, 255, 255, 0.3)', backgroundColor: 'rgba(255, 255, 255, 0.1)', borderWidth: 1, borderDash: [5,5], tension: 0.3, fill: false }
        ]
      },
      options: {
        responsive: true,
        plugins: { legend: { labels: { color: 'white' } } },
        scales: {
          x: { ticks: { display: false }, grid: { color: 'rgba(255,255,255,0.1)' } },
          y: { ticks: { color: 'white' }, grid: { color: 'rgba(255,255,255,0.1)' } }
        }
      }
    });

    const starTypes = [
      "Star of Happy", "Star of Shiny", "Star of Luck", "Star of Peace", "Star of Joy",
      "Star of Dreams", "Star of Magic", "Star of Wonder", "Star of Hope", "Star of Light",
      "Star of Night", "Star of Dawn", "Star of Energy", "Star of Love", "Star of Mystery"
    ];

    function saveState() {
      localStorage.setItem(getKey('number'), currentNumber);
      localStorage.setItem(getKey('labels'), JSON.stringify(numberChart.data.labels));
      localStorage.setItem(getKey('liveData'), JSON.stringify(numberChart.data.datasets[0].data));
      localStorage.setItem(getKey('offlineData'), JSON.stringify(numberChart.data.datasets[1].data));
      localStorage.setItem(getKey('stars'), JSON.stringify([...starsList.children].map(li => li.textContent)));
      localStorage.setItem(getKey('lastUpdate'), Date.now());
    }

    function randomStep() {
      const random = Math.random();
      if (random < 0.5) currentNumber += 1;
      else if (random < 0.75) currentNumber -= 1;
    }

    function updateNumber() {
      numberDisplay.classList.add('number-change');
      setTimeout(() => numberDisplay.classList.remove('number-change'), 500);

      randomStep();

      numberDisplay.textContent = currentNumber;
      step++;
      numberChart.data.labels.push(step);
      numberChart.data.datasets[0].data.push(currentNumber);
      numberChart.update();

      saveState();
    }

    function addStar() {
      const chanceDisappear = Math.random();
      // 20% chance a star disappears
      if (starsList.children.length > 0 && chanceDisappear < 0.2) {
        starsList.removeChild(starsList.children[Math.floor(Math.random() * starsList.children.length)]);
      } else {
        const star = starTypes[Math.floor(Math.random() * starTypes.length)];
        const li = document.createElement("li");
        li.textContent = `⭐ ${star}`;
        starsList.appendChild(li);
      }
      saveState();
    }

    submitBtn.addEventListener('click', () => {
      const inputValue = parseInt(numberInput.value);
      if (isNaN(inputValue)) {
        alert('Please enter a valid number');
        return;
      }

      if (intervalId) clearInterval(intervalId);

      currentNumber += inputValue; // add instead of replace
      numberDisplay.textContent = currentNumber;
      step++;
      numberChart.data.labels.push(step);
      numberChart.data.datasets[0].data.push(currentNumber);
      numberChart.update();

      saveState();

      intervalId = setInterval(updateNumber, 3000);
      if (!starIntervalId) starIntervalId = setInterval(addStar, 15000); // every 15s
    });

    clearBtn.addEventListener('click', () => {
      localStorage.removeItem(getKey('number'));
      localStorage.removeItem(getKey('labels'));
      localStorage.removeItem(getKey('liveData'));
      localStorage.removeItem(getKey('offlineData'));
      localStorage.removeItem(getKey('stars'));
      localStorage.removeItem(getKey('lastUpdate'));

      if (intervalId) { clearInterval(intervalId); intervalId = null; }
      if (starIntervalId) { clearInterval(starIntervalId); starIntervalId = null; }

      currentNumber = 10; // reset to 10
      step = 0;
      numberDisplay.textContent = '10';
      numberInput.value = '';
      starsList.innerHTML = '';
      numberChart.data.labels = [];
      numberChart.data.datasets[0].data = [];
      numberChart.data.datasets[1].data = [];
      numberChart.update();
    });

    window.addEventListener('load', () => {
      const savedNumber = localStorage.getItem(getKey('number'));
      const savedLabels = JSON.parse(localStorage.getItem(getKey('labels')) || '[]');
      const savedLiveData = JSON.parse(localStorage.getItem(getKey('liveData')) || '[]');
      const savedOfflineData = JSON.parse(localStorage.getItem(getKey('offlineData')) || '[]');
      const savedStars = JSON.parse(localStorage.getItem(getKey('stars')) || '[]');
      const lastUpdate = parseInt(localStorage.getItem(getKey('lastUpdate')) || '0');

      if (savedNumber !== null) {
        currentNumber = parseInt(savedNumber);
        numberDisplay.textContent = currentNumber;
        numberInput.value = "";

        step = savedLabels.length > 0 ? savedLabels[savedLabels.length - 1] : 0;
        numberChart.data.labels = savedLabels;
        numberChart.data.datasets[0].data = savedLiveData;
        numberChart.data.datasets[1].data = savedOfflineData;
        numberChart.update();

        starsList.innerHTML = "";
        savedStars.forEach(star => {
          const li = document.createElement("li");
          li.textContent = star;
          starsList.appendChild(li);
        });

        // Simulate offline progression
        if (lastUpdate > 0) {
          const now = Date.now();
          const elapsed = Math.floor((now - lastUpdate) / 30000); // 30s chunks
          for (let i = 0; i < elapsed; i++) {
            randomStep();
            step++;
            numberChart.data.labels.push(step);
            numberChart.data.datasets[1].data.push(currentNumber);
          }
          numberDisplay.textContent = currentNumber;
          numberChart.update();
          saveState();
        }

        intervalId = setInterval(updateNumber, 3000);
        if (!starIntervalId) starIntervalId = setInterval(addStar, 15000); // every 15s
      } else {
        // Default starting state
        currentNumber = 10;
        numberDisplay.textContent = '10';
      }
    });
  </script>
</body>
</html>
